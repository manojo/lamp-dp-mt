#!/bin/sh
# Mostly copied from GAPC/librna
# from ViennaRNA-2.0.7 (not changed): vienna/ folder
# imported from adpc 0.9 (heavily changed): rnalib.[ch]

JAVA_INCLUDE="$JAVA_HOME/include"
if [ "$OSTYPE" = "darwin" ]; then
  JAVA_INCLUDE="/System/Library/Frameworks/JavaVM.framework/Headers"
fi

if [ "$1" = "" ]; then out="bin"; rm -r "$out" 2>/dev/null;
else from=`pwd`; mkdir -p "$1"; cd "$1"; out=`pwd`; cd $from; fi
cd `dirname $0`;

# scalac -d "$out" RNALib.scala || exit

name="libRNA.jnilib"
md5 -q -s *.[ch] vienna/*.[ch] > "$out/$name.tmp"
if diff "$out/$name.md5" "$out/$name.tmp" 1>/dev/null 2>/dev/null && [ -f "$out/$name" ] ; then
	echo 'Already updated.'; exit;
fi

printf "Compiling $name"
gcc -Wall -std=c99 -shared -I"$JAVA_INCLUDE" rnalib.c librna.c \
	vienna/energy_par.c vienna/fold_vars.c vienna/params.c vienna/read_epars.c vienna/utils.c \
	-o "$out"/libRNA.jnilib || exit
mv "$out/$name.tmp" "$out/$name.md5"
echo '.'

# execute
# scala -cp bin Test
