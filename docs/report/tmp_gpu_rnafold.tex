\documentclass[11pt]{article}
\usepackage{amssymb,amsmath,amsthm,hyperref,verbatim,pict2e,graphicx,marvosym,array,booktabs}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\pagestyle{empty} % remove page numbers

\begin{document}

$Q'_{i,j}$ is the minimum energy of folding of a subsequence $i,j$ given that bases $i$ and $j$ form a base pair; $Q_{i,j}$ and $QM_{i,j}$ are the minimum energy of folding of the subsequence $i,j$ assuming that this subsequence is inside a multiloop and that it contains respectively at least one and two base pairs. A simplified model of the recursion relations can be written as:

\[\begin{array}{rcl}
Q'_{i,j}&=&\left\{\begin{array}{ll}
	\min\left\{\begin{array}{l}
	Eh(i,j) \\
	Es(i,j)+Q'_{i+1,j-1} \\
	\min\limits_{i<k<l<j}Ei(i,j,k,l)+Q'_{k,l} \\
	QM_{i+1,j-1}
	\end{array}\right. & \text{if } (i,j) \text{ is a basepair}\\
	\infty & \text{otherwise} \\
	\end{array}\right. \\
QM_{i,j} &=& \min\limits_{i<k<j}(Q_{i,k}+Q_{k+1,j})\\
Q_{i,j} &=& \min\{ QM_{i,j}, Q_{i+1,j},Q_{i,j-1},Q'_{i,j} \}
\end{array}\]
\begin{itemize}
\item $Eh(i,j)$ energy of hairpin loop closed by the pair $i \cdot j$.
\item $Ei(i,j,k,l)$ energy of interior loop formed by two base pairs $i \cdot j$, $k \cdot l$.
\item $Es(i,j)$ energy of two stacked base pairs $i\cdot j$ and $(i+1)\cdot(j-1)$.
\end{itemize}

This converts to the grammar
\begin{verbatim}

Qp=tabulate("Qp",(
  seq            ^^ x => Eh(x._1,x._2-1)
| eli ~ Qp ~ eli ^^ (a,b,c) => Es(a,c) + b
| seq ~ Qp ~ seq ^^ (a,b,c) => Ei(a._1,b._2-1,a._2-1,b._1) + b
| el ~ QM  ~ el  ^^ (a,b,c) => b
) filter base aggregate h)

QM=tabulate("QM",(
  Q ~ Q ^^ (a,b)=>a+b
) aggregate h) // with size >= 4

Q=tabulate("Q",(
  QM
| el ~ Q ^^ (a,b) => b
| Q ~ el ^^ (a,b) => a
| Qp
) aggregate h) // with size >= 2

\end{verbatim}

\end{document}
